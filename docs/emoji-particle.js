var canvas,ctx,width,height,rockets=[],particles=[],popcornEmojiList=["ðŸ¿","ðŸŒ½","ðŸ¥¤","ðŸ¥¨","ðŸ«","ðŸ£"],fireworkEmojiList=["âœ¨","â­ï¸","ðŸ’¥","ðŸŒŸ","ðŸ”¥","ðŸ’«"],rocketEmojiList=["ðŸš€","ðŸ§¨","ðŸ’£","ðŸª„","ðŸ›¸"],emojiCache=new Map;self.onmessage=async e=>{e.data.type==="init"?(canvas=e.data.canvas,ctx=canvas.getContext("2d"),width=canvas.width,height=canvas.height,await prepareEmojiCache([...popcornEmojiList,...fireworkEmojiList,...rocketEmojiList]),requestAnimationFrame(loop)):e.data.type==="spawn"?spawn(e.data.options):e.data.type==="resize"&&(width=e.data.width,height=e.data.height,canvas.width=width,canvas.height=height)};async function emojiToBitmap(e,t=64){const s=new OffscreenCanvas(t,t),n=s.getContext("2d");return n.font=`${t}px serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(e,t/2,t/2),await createImageBitmap(s)}async function prepareEmojiCache(e,t=64){for(const n of e)if(typeof n=="string"){if(!emojiCache.has(n)){const e=await emojiToBitmap(n,t);emojiCache.set(n,e)}}else n instanceof ImageBitmap?emojiCache.has(n)||emojiCache.set(n,n):console.warn("Unsupported emoji item:",n)}function spawn(e){const{particleType:r="popcorn",originX:a=width/2,originY:s=height/2,count:o=20,size:i=30,minSpeed:t=5,maxSpeed:n=10,angle:c=-Math.PI/2,angleVariance:l=Math.PI/6,gravity:d=.2,lifeTime:u=100,fade:h=!0,explosionOptions:m={}}=e;if(r==="popcorn")for(let e=0;e<o;e++){const r=t+Math.random()*(n-t),m=c+(Math.random()-.5)*l,f=popcornEmojiList[Math.floor(Math.random()*popcornEmojiList.length)];particles.push({type:"emoji",emoji:f,size:i,x:a,y:s,vx:Math.cos(m)*r,vy:Math.sin(m)*r,gravity:d,age:0,lifeTime:u,fade:h})}else if(r==="rocket")for(let e=0;e<o;e++){const r=t+Math.random()*(n-t),h=c+(Math.random()-.5)*l,f=rocketEmojiList[Math.floor(Math.random()*rocketEmojiList.length)];rockets.push({emoji:f,x:a,y:s,vx:Math.cos(h)*r,vy:Math.sin(h)*r,gravity:d,age:0,lifeTime:u,size:i,explosionOptions:m})}}function spawnExplosion(e,t,n={}){const{count:i=20,size:a=20,minSpeed:s=2,maxSpeed:r=7,angle:c=0,angleVariance:l=Math.PI*2,gravity:d=.1,lifeTime:u=80,fade:h=!0,emojiList:o=fireworkEmojiList}=n;for(let n=0;n<i;n++){const m=s+Math.random()*(r-s),f=c+(Math.random()-.5)*l,p=o[Math.floor(Math.random()*o.length)];particles.push({type:"emoji",emoji:p,x:e,y:t,vx:Math.cos(f)*m,vy:Math.sin(f)*m,gravity:d,age:0,lifeTime:u,fade:h,size:a})}}function update(){for(let t=rockets.length-1;t>=0;t--){const e=rockets[t];e.vy+=e.gravity,e.x+=e.vx,e.y+=e.vy,e.age++,e.age>=e.lifeTime&&(spawnExplosion(e.x,e.y,e.explosionOptions),rockets.splice(t,1))}for(let t=particles.length-1;t>=0;t--){const e=particles[t];e.vy+=e.gravity,e.x+=e.vx,e.y+=e.vy,e.age++,e.age>=e.lifeTime&&particles.splice(t,1)}}function draw(){ctx.clearRect(0,0,width,height);for(const e of rockets){const t=emojiCache.get(e.emoji);t&&(ctx.globalAlpha=1,ctx.drawImage(t,e.x-e.size/2,e.y-e.size/2,e.size,e.size))}for(const e of particles){const t=emojiCache.get(e.emoji);if(t){const n=e.fade?1-e.age/e.lifeTime:1;ctx.globalAlpha=n,ctx.drawImage(t,e.x-e.size/2,e.y-e.size/2,e.size,e.size),ctx.globalAlpha=1}}}function loop(){update(),draw(),requestAnimationFrame(loop)}